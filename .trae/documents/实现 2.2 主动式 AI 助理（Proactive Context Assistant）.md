## 目标与范围
- 在录制过程中检测“显著窗口变化”，异步触发一次“上下文检索/建议生成”，并通过事件 `context-suggestion` 推送到前端侧边栏。
- 全程不阻塞 `recording_loop` 主链路，具备超时、panic 隔离与开关控制。

## 现状定位（已确认）
- 录制主循环与 emit 集中在 [recorder.rs](file:///d:/Demo/memflow/src-tauri/src/recorder.rs)（已有 `backend-log` / `new-activity` / `ocr-updated`）。
- 前台窗口信息获取在 [window_info.rs](file:///d:/Demo/memflow/src-tauri/src/window_info.rs)（Windows API）。
- AI/RAG 能力在 [ai/mod.rs](file:///d:/Demo/memflow/src-tauri/src/ai/mod.rs) 与 [ai/rag.rs](file:///d:/Demo/memflow/src-tauri/src/ai/rag.rs)。
- 前端统一监听后端事件在 [AppContext.tsx](file:///d:/Demo/memflow/src/contexts/AppContext.tsx)。

## 后端实现（Rust / Tauri）
1. 新增配置开关
   - 在 [commands.rs](file:///d:/Demo/memflow/src-tauri/src/commands.rs) 的 `AppConfig` 增加 `enable_proactive_assistant: bool`（默认 false，保持旧配置兼容）。
   - 逻辑 gating：仅当 `enable_proactive_assistant && ai_enabled` 才会触发；隐私模式下不触发（避免泄露窗口标题）。

2. 新增“主动上下文”模块
   - 新建 `src-tauri/src/proactive_context.rs` 并在 [lib.rs](file:///d:/Demo/memflow/src-tauri/src/lib.rs) 注册模块。
   - 提供 `maybe_trigger(window_info, app_handle)`：
     - 维护最近一次上下文（进程名+窗口标题）与最近触发时间（节流）。
     - 使用 Levenshtein 距离判断“显著变化”（同时把“应用切换”视为显著变化）。
     - `tokio::spawn` 异步隔离 + `catch_unwind` 防 panic 扩散 + `timeout`（例如 3–5s）防挂起。

3. 生成与推送建议
   - 在 `spawn` 内：
     - 构造 query：`"{app} {title}"`。
     - 优先使用 `HybridSearch::search` 检索相关活动（Related Memories），再 `db::get_activity_by_id` 补齐必要字段。
     - 如 chat key/模型可用则可选生成 `Suggested Actions`（LLM 输出 JSON/数组）；若不可用则只返回 related 结果（保证功能可用）。
   - 统一 payload（serde `camelCase`）并 `emit("context-suggestion", payload)`。

4. 在录制链路注入触发点（最小侵入）
   - 在 [recorder.rs](file:///d:/Demo/memflow/src-tauri/src/recorder.rs) 的 `capture_and_save()` 中：
     - 完成隐私/黑名单判断后、截图前，调用 `proactive_context::maybe_trigger(...)`。
     - 该调用只做轻量比较与 `spawn`，不做任何 await-heavy 操作，确保不会拖慢截图频率。

## 前端实现（React）
1. 新增侧边栏组件
   - 新建 `src/components/ContextSidebar.tsx`：
     - `listen('context-suggestion')` 接收 payload。
     - 3–5 秒防抖展示（只显示最后一次 suggestion），避免窗口频繁切换导致闪烁。
     - 展示：当前上下文（app/title）+ Related Memories 列表（可点击：切到时间轴并按时间范围/应用过滤）。

2. 集成到布局
   - 修改 [Layout.tsx](file:///d:/Demo/memflow/src/components/Layout.tsx)：主内容区改为 `flex`，右侧固定宽度渲染 `ContextSidebar`（不影响顶部栏）。

3. 设置项（可选但推荐）
   - 在 [SettingsModal.tsx](file:///d:/Demo/memflow/src/components/SettingsModal.tsx) 增加“主动式 AI 助理”开关，保存到后端配置。
   - 同步更新 [AppContext.tsx](file:///d:/Demo/memflow/src/contexts/AppContext.tsx) 的 `AppConfig` 类型与默认值，避免类型不一致。

## 测试与验证（实施后执行）
- Rust：新增 Levenshtein/显著变化判断的单元测试；运行 `cargo test --manifest-path src-tauri/Cargo.toml`。
- 前端：运行 `npm run type-check` 与 `npm run build` 确认 TSX/构建通过。
- 集成：`npm run tauri:build` 或至少 `cargo build`（视环境而定）确保 Tauri 编译通过。

## 风险控制
- 所有 AI 调用均在独立任务中执行，并带超时与 panic 捕获；任何失败只会导致本次 suggestion 缺失，不会影响录制主循环。

确认后我将开始按以上步骤落地实现，并在完成后给出编译与测试结果。