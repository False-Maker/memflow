# MemFlow 项目架构文档

## 项目概述

MemFlow 是一个智能桌面活动记录与分析工具，专注于视觉记忆功能。通过自动截图、OCR文本提取、AI分析等技术，帮助用户记录和分析计算机活动，构建个人知识图谱。

## 技术栈

### 前端技术栈
- **框架**: React 18 + TypeScript
- **构建工具**: Vite
- **UI框架**: Tailwind CSS
- **动画**: Framer Motion
- **图标**: Lucide React
- **图表**: Recharts
- **虚拟化**: React Virtuoso
- **图谱可视化**: React Force Graph 2D

### 后端技术栈
- **框架**: Tauri 2.0 (Rust)
- **数据库**: SQLite + SQLx
- **异步运行时**: Tokio
- **截图**: xcap
- **OCR**: Windows OCR API + RapidOCR
- **AI客户端**: reqwest (支持OpenAI兼容API)
- **加密**: AES-GCM + keyring
- **图像处理**: image crate

## 系统架构

### 整体架构图

```
┌─────────────────────────────────────────────────────────────┐
│                    前端 (React + TypeScript)                 │
├─────────────────────────────────────────────────────────────┤
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────┐ │
│  │   Timeline  │ │ Knowledge   │ │  FlowState  │ │Settings │ │
│  │   视图组件   │ │   Graph     │ │   统计组件   │ │ 设置组件 │ │
│  └─────────────┘ └─────────────┘ └─────────────┘ └─────────┘ │
├─────────────────────────────────────────────────────────────┤
│                    Tauri IPC 通信层                         │
├─────────────────────────────────────────────────────────────┤
│                   后端 (Rust + Tauri)                       │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────┐ │
│  │   录制模块   │ │   OCR模块   │ │   AI模块    │ │ 数据库   │ │
│  │  Recorder   │ │    OCR      │ │     AI      │ │   DB    │ │
│  └─────────────┘ └─────────────┘ └─────────────┘ └─────────┘ │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────┐ │
│  │  智能代理   │ │  向量数据库  │ │  性能监控   │ │ 安全存储 │ │
│  │   Agent     │ │  VectorDB   │ │Performance  │ │SecureStore│ │
│  └─────────────┘ └─────────────┘ └─────────────┘ └─────────┘ │
├─────────────────────────────────────────────────────────────┤
│                      系统层                                 │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────┐ │
│  │  屏幕截图   │ │  输入监听   │ │  文件系统   │ │ 系统API  │ │
│  │ Screenshot  │ │InputMetrics │ │FileSystem   │ │SystemAPI│ │
│  └─────────────┘ └─────────────┘ └─────────────┘ └─────────┘ │
└─────────────────────────────────────────────────────────────┘
```

## 功能架构

### 核心功能模块

#### 1. 活动录制系统 (Recording System)
- **录制器 (Recorder)**: 定时截图和活动捕获
- **智能节流**: 基于图像哈希的重复帧检测
- **应用监控**: 窗口标题和应用名称获取
- **输入监控**: 键盘鼠标活动统计

#### 2. OCR文本提取系统 (OCR System)
- **多引擎支持**: Windows OCR API + RapidOCR
- **进程池管理**: OCR任务队列和进程复用
- **优先级队列**: 基于任务重要性的处理顺序
- **文本块识别**: 坐标信息和文本内容提取

#### 3. AI分析系统 (AI System)
- **多模态支持**: 文本+图像的AI分析
- **API兼容**: 支持OpenAI兼容的API接口
- **功能模块**:
  - 日常总结生成
  - 上下文对话
  - 项目报告生成
  - 健康提醒检查

#### 4. 智能代理系统 (Agent System)
- **自主任务执行**: 基于用户习惯的自动化
- **例程生成**: 从用户行为模式生成工作流程
- **执行历史**: 代理操作的记录和撤销
- **紧急停止**: 安全机制防止误操作

#### 5. 知识图谱系统 (Knowledge Graph)
- **实体提取**: 从活动数据中提取关键实体
- **关系建模**: 应用、文档、时间的关联关系
- **图谱可视化**: 交互式知识图谱展示
- **向量嵌入**: 文本语义相似度计算

#### 6. 数据管理系统 (Data Management)
- **SQLite数据库**: 活动日志、配置、元数据存储
- **向量数据库**: 文本嵌入向量存储
- **数据迁移**: 版本升级时的数据结构迁移
- **备份恢复**: 数据备份和恢复功能

#### 7. 安全存储系统 (Security System)
- **密钥管理**: 系统密钥库存储API密钥
- **数据加密**: AES-GCM加密敏感数据
- **访问控制**: 应用黑名单和权限管理
- **隐私保护**: 敏感信息检测和过滤

### 数据流架构

```
用户活动 → 屏幕截图 → OCR文本提取 → 数据存储 → AI分析 → 知识图谱
    ↓           ↓           ↓           ↓         ↓         ↓
输入监控 → 应用监控 → 文本处理 → 向量嵌入 → 智能代理 → 用户界面
```

## 技术架构

### 前端架构

#### 组件层次结构
```
App (根组件)
├── Layout (布局组件)
│   ├── Timeline (时间轴视图)
│   ├── KnowledgeGraph (知识图谱)
│   └── FlowState (统计面板)
├── SettingsModal (设置弹窗)
├── AgentProposalModal (代理提案弹窗)
├── AgentHistoryModal (代理历史弹窗)
├── FeedbackModal (反馈弹窗)
└── PerformanceModal (性能监控弹窗)
```

#### 状态管理
- **本地状态**: useState, useEffect
- **配置管理**: useAppConfig Hook
- **事件通信**: Tauri事件系统

#### 样式系统
- **设计系统**: 基于Tailwind的暗色主题
- **动画**: Framer Motion提供流畅过渡
- **响应式**: 适配不同屏幕尺寸

### 后端架构

#### 模块组织
```
src-tauri/src/
├── main.rs              # 应用入口和初始化
├── commands.rs          # Tauri命令处理
├── db.rs               # 数据库初始化
├── recorder.rs         # 录制核心逻辑
├── ocr/                # OCR相关模块
│   ├── ocr.rs          # OCR接口定义
│   ├── ocr_windows.rs  # Windows OCR实现
│   ├── ocr_sidecar.rs  # RapidOCR实现
│   ├── ocr_pool.rs     # OCR进程池
│   └── ocr_queue.rs    # OCR任务队列
├── ai/                 # AI相关模块
│   ├── ai.rs           # AI功能实现
│   └── ai_client.rs    # AI客户端
├── agent/              # 智能代理模块
│   ├── core.rs         # 代理核心逻辑
│   ├── executor.rs     # 任务执行器
│   └── prompts.rs      # 提示词模板
├── graph.rs            # 知识图谱
├── vector_db.rs        # 向量数据库
├── secure_storage.rs   # 安全存储
├── performance.rs      # 性能监控
├── backup.rs           # 备份恢复
├── cleaner.rs          # 数据清理
├── migrations.rs       # 数据库迁移
└── app_config.rs       # 配置管理
```

#### 并发模型
- **异步运行时**: Tokio提供异步I/O
- **任务调度**: 多个后台任务并行运行
- **线程安全**: Arc + Mutex保证数据安全
- **进程池**: OCR任务的进程级并发

#### 数据库设计
```sql
-- 主要数据表
activity_logs        # 活动日志
vector_embeddings    # 向量嵌入
knowledge_graph      # 知识图谱
agent_executions     # 代理执行历史
feedback_entries     # 用户反馈
performance_metrics  # 性能指标
```

## 部署架构

### 构建流程
1. **前端构建**: Vite构建React应用
2. **后端编译**: Cargo编译Rust代码
3. **资源打包**: Tauri打包为桌面应用
4. **平台适配**: 支持Windows/macOS/Linux

### 文件结构
```
应用目录/
├── memflow.exe          # 主程序
├── resources/           # 资源文件
│   └── ocr-*.exe       # OCR可执行文件
└── 用户数据目录/
    ├── memflow.db      # 数据库文件
    ├── screenshots/    # 截图存储
    ├── config.json     # 配置文件
    └── backups/        # 备份文件
```

### 系统集成
- **全局快捷键**: Alt+Space唤起/隐藏
- **系统托盘**: 后台运行支持
- **开机启动**: 可选的自动启动
- **权限管理**: 屏幕录制权限申请

## 性能优化

### 前端优化
- **虚拟化滚动**: 大量数据的高效渲染
- **图片懒加载**: 按需加载截图资源
- **组件缓存**: React.memo优化重渲染
- **状态优化**: 减少不必要的状态更新

### 后端优化
- **智能节流**: 基于图像哈希的重复检测
- **进程池**: OCR任务的进程复用
- **数据库优化**: 索引和查询优化
- **内存管理**: 及时释放大对象

### 存储优化
- **图片压缩**: 智能压缩减少存储空间
- **数据清理**: 定期清理过期数据
- **增量备份**: 只备份变更数据
- **向量压缩**: 嵌入向量的压缩存储

## 安全架构

### 数据安全
- **本地存储**: 所有数据存储在本地
- **加密存储**: API密钥使用系统密钥库
- **访问控制**: 应用级别的权限管理
- **数据脱敏**: 敏感信息自动检测和过滤

### 隐私保护
- **应用黑名单**: 排除敏感应用的录制
- **数据最小化**: 只收集必要的数据
- **用户控制**: 完全的数据控制权
- **透明度**: 开源代码保证透明

## 扩展性设计

### 插件架构
- **OCR引擎**: 支持多种OCR引擎切换
- **AI提供商**: 支持多种AI API
- **存储后端**: 可扩展的存储方案
- **分析模块**: 可插拔的分析功能

### API设计
- **命令模式**: Tauri命令的统一接口
- **事件驱动**: 基于事件的异步通信
- **配置驱动**: 通过配置控制功能开关
- **版本兼容**: 向后兼容的API设计

## 监控与运维

### 性能监控
- **系统指标**: CPU、内存、磁盘使用率
- **应用指标**: 录制频率、OCR性能、AI响应时间
- **错误监控**: 异常捕获和错误通知
- **用户反馈**: 内置反馈收集系统

### 日志系统
- **结构化日志**: 便于分析的日志格式
- **日志级别**: 不同级别的日志输出
- **日志轮转**: 防止日志文件过大
- **错误追踪**: 详细的错误堆栈信息

这个架构设计确保了MemFlow的高性能、安全性和可扩展性，为用户提供了一个强大而易用的桌面活动记录与分析工具。